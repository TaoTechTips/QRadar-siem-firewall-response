### 1. Test Connection

  SSH into pfSense from your QRadar console cli using the following command:
  
  ``` text
  ssh -i ~/.ssh/id_rsa qradar_usr@10.10.1.1
  ```
  
  replace `~/.ssh/id_rsa` with your QRadar private key path, `qradar_usr` with the user you created and `10.10.1.1` with the ip of your pfSense firewall
  
  You would most likely get the following error message:
  
  ```text
  [root@qracon ~]# ssh -i ~/.ssh/id_rsa.pub qradar_usr@10.10.1.1
  No ED25519 host key is known for 10.10.1.1 and you have requested strict checking.
  Host key verification failed.
  ```
  
  This means QRadar does not trust pfSense's SSH host key yet. You can fix that by running the following command:
  
  ``` text
  ssh-keyscan -t ed25519 <pfSense ip here> >> ~/.ssh/known_hosts
  ```
  replace `<pfSense ip here>` with your pfSense ip address.
  
  <img width="630" height="58" alt="image" src="https://github.com/user-attachments/assets/97466524-342b-49ce-8367-c69aabe1dbe8" />
  
  The output above shows the command ran successfully.
  
  You can try to ssh again now and it should work fine.
  
  <img width="686" height="54" alt="image" src="https://github.com/user-attachments/assets/4a7b0762-dbcf-4ee1-abe7-57897757c0ca" />


  Due to the way custom actions are processed on QRadar.

  _A script can run only from inside the jail environment so that it does not interfere with the QRadar run environment. All file access during custom action execution     is relative to the `/opt/qradar/bin/ca_jail/` directory._

  We need to create a copy of our private key in the `customactionuser's` home directory

  ```text
  mkdir -p /opt/qradar/bin/ca_jail/home/customactionuser/.ssh
  cp /root/.ssh/id_rsa /opt/qradar/bin/ca_jail/home/customactionuser/.ssh/
  chown -R customactionuser:customactionuser /opt/qradar/bin/ca_jail/home/customactionuser/.ssh
  chmod 700 /opt/qradar/bin/ca_jail/home/customactionuser/.ssh
  chmod 600 /opt/qradar/bin/ca_jail/home/customactionuser/.ssh/id_rsa
  ```

  -- _In the `cp` command, you can replace `/root/.ssh/id_rsa` with the path to the private key you want to use._
  
  The private key path will be referenced in the `block_ip_pfsense.sh` script
  
  Now that ssh connection is working fine, and our private key is setup in the right directory we can move on to testing the command to add ip to block list and remove ip from block   list.

### 2. Manual test for adding ip address to blocklist

  Run the following command to add `1.2.3.4` to the ip block list:

  ```text
  sudo pfctl -t qradar_blocklist -T add 1.2.3.4
  ```

  <img width="887" height="51" alt="image" src="https://github.com/user-attachments/assets/7ba4c6b1-9ed8-4ff9-9340-01d8e933580a" />

  Success! we can confirm the content of the blocklist with the following command:

  ```text
  sudo pfctl -t qradar_blocklist -T show
  ```

  <img width="851" height="53" alt="image" src="https://github.com/user-attachments/assets/266cc6d6-4882-4438-b698-34d06728555a" />

### 3. Manual test for removing ip address from blocklist
  Run the following command to  remove `1.2.3.4` from the block list:

  ```text
  sudo pfctl -t qradar_blocklist -T delete 1.2.3.4
  ```

  <img width="900" height="83" alt="image" src="https://github.com/user-attachments/assets/f28a9dcb-73de-4d85-b24e-e0c0429b6f5a" />

  Success! we see that the ip `1.2.3.4` was removed from the block list.


### References
https://www.ibm.com/docs/en/qsip/7.5?topic=tasks-adding-custom-actions
